<section class="container-fluid px-4">
  <app-error [error]="error"></app-error>
  <div class="d-flex my-2 justify-content-end">
    <app-button [classes]="['btn-secondary']" (click)="changeTab(-1)" icon="fas ArrowLeft">Previous</app-button>
    <app-button class="me-5" [classes]="['btn-secondary']" (click)="changeTab(1)" icon="fas ArrowRight">Next
    </app-button>
    <button class="btn btn-primary" (click)="syncPlaylist()">
      <fa-icon *ngIf="isSyncing" [icon]="loadingIcon" [spin]="true"></fa-icon>
      Sync!
    </button>
  </div>

  <div class="row row-cols-2">
    <div class="col">
      <h3>Merged result
        <fa-icon class="ms-3" [icon]="pinnedIcon"></fa-icon>
      </h3>
      <ng-container
        *ngTemplateOutlet="changeTemplate; context: {changes: mergedChanges} "></ng-container>
    </div>
    <div class="col">
      <ul ngbNav #nav="ngbNav" class="nav-tabs" [(activeId)]="activeTab">
        <li [ngbNavItem]="1">
          <ng-template ngbNavContent>
            <h3>Current original playlist<br><small>vs</small><br> Old original playlist</h3>
            <div *ngIf="originalPlaylistHasChanged;else noChangesInOriginal">
              <ng-container
                *ngTemplateOutlet="changeTemplate; context: {direction: 'left', changes: changesInOriginal} "></ng-container>
            </div>
            <ng-template #noChangesInOriginal>
              <p>The original playlist has not changed after remixing took place.</p>
            </ng-template>
          </ng-template>
        </li>
        <li [ngbNavItem]="2">
          <ng-template ngbNavContent>
            <h3>Current remixed playlist<br><small>vs</small><br> Current original playlist</h3>
            <ng-container
              *ngTemplateOutlet="changeTemplate; context: {direction: 'left', changes: changesInRemix} "></ng-container>
          </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav"></div>
    </div>
  </div>

  <div *ngIf="isLoading" class="d-flex justify-content-center">
    <fa-icon [icon]="loadingIcon" [spin]="true"></fa-icon>
  </div>
</section>


<ng-template #changeTemplate let-direction="direction" let-changes="changes">
  <div>
    <div
      *ngFor="let diff of changes; let i = index"
      class="card my-1"
    >
      <div class="row g-0">
        <div class="col-md-2">
          <img [src]="diff[1].track.album.images[1].url" class="h-100 img-fluid rounded-start object-fit-cover"
               alt="Album cover not found">
        </div>
        <div
          *ngIf="direction"
          [ngClass]="determineCSSClass(diff)"
          class="border-end col-md-2 d-flex flex-column justify-content-between align-items-center actions-container"
        >
          <button
            class="add-back-action w-100 h-50 d-flex justify-content-center align-items-center border-bottom"
            [disabled]="diff[0] === 0"
            (click)="onAddBackAction(diff, i)"
          >
            <fa-icon
              size="2x"
              [icon]="determineAddBackIcon(direction)"
            ></fa-icon>
          </button>

          <button
            class="keep-removed-action w-100 h-50 d-flex justify-content-center align-items-center"
            [disabled]="diff[0] !== -1"
            (click)="onKeepRemoved(diff)"
          >
            <fa-icon
              size="2x"
              [icon]="keepRemovedIcon"
            ></fa-icon>
          </button>
        </div>
        <div class="col-md-8" [ngClass]="determineCSSClass(diff)">
          <div class="card-body">
            <h6 class="card-title text-truncate">{{ diff[1].track.name }}</h6>
            <p class="card-text">
              <small [innerHTML]="generateArtistList(diff[1])"></small>
            </p>
            <app-audio [src]="diff[1].track.preview_url"></app-audio>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>
